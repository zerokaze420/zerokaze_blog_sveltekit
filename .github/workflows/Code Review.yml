# DeepSeek Code Review on Push
## æ­¤å·¥ä½œæµåœ¨æ¯æ¬¡æ¨é€åˆ° dev åˆ†æ”¯æ—¶è§¦å‘ï¼Œè‡ªåŠ¨ä½¿ç”¨ DeepSeek AI è¿›è¡Œä»£ç å®¡æŸ¥ã€‚
# å¦‚æœ AI å‘ç°é—®é¢˜ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«å®¡æŸ¥æ„è§çš„ GitHub Issueã€‚
on:
  push:
    branches:
      - main # ç¡®ä¿æ­¤åˆ†æ”¯ä¸ä½ çš„ä¸»åˆ†æ”¯åç§°ä¸€è‡´

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write # å…è®¸åˆ›å»º Issue
      pull-requests: write # ä¿ç•™æ­¤æƒé™ä»¥åœ¨éœ€è¦æ—¶æ“ä½œ Pull Request
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Get code changes
        id: get_diff
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¸ºé¦–æ¬¡æ¨é€ï¼ˆ`before`ä¸ºå…¨0ï¼‰
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "è¿™æ˜¯åˆ†æ”¯çš„é¦–æ¬¡æ¨é€ï¼Œè·å–æœ€æ–°æäº¤çš„å·®å¼‚ã€‚"
            DIFF=$(git show --format=fuller --binary ${{ github.event.after }})
          else
            echo "è·å–æœ¬æ¬¡æ¨é€çš„å·®å¼‚ã€‚"
            DIFF=$(git diff ${{ github.event.before }} ${{ github.event.after }})
          fi
          # é™åˆ¶å·®å¼‚å¤§å°ä»¥é¿å…APIé”™è¯¯
          if [ $(echo -n "$DIFF" | wc -c) -gt 32000 ]; then
            echo "::warning::å·®å¼‚å†…å®¹è¿‡å¤§ï¼Œå·²æˆªæ–­ã€‚"
            DIFF=$(echo -n "$DIFF" | head -c 32000)
          fi
          # å°†å·®å¼‚å†…å®¹ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¸­
          echo "DIFF_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      - name: Request DeepSeek API for code review
        id: deepseek_review
        uses: actions/github-script@v6
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DIFF_CONTENT: ${{ env.DIFF_CONTENT }}
        with:
          script: |
            const { DEEPSEEK_API_KEY, DIFF_CONTENT } = process.env;
            if (!DIFF_CONTENT) {
              console.log("æœªå‘ç°ä»£ç å˜åŠ¨ï¼Œè·³è¿‡ä»£ç å®¡æŸ¥ã€‚");
              core.setOutput('review_comment', 'ä»£ç å®¡æŸ¥é€šè¿‡ï¼Œæ²¡æœ‰å‘ç°ä»£ç å˜åŠ¨ã€‚');
              return;
            }
            // æç¤ºè¯ä¿æŒä¸å˜ï¼Œä»¥ä¾¿ AI ä»ç„¶æä¾›è¯„åˆ†
            const prompt = `ä½ æ˜¯ä¸€åèµ„æ·±è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹ä»£ç å·®å¼‚è¿›è¡Œä¸“ä¸šçš„ä»£ç å®¡æŸ¥ã€‚è¯·é‡ç‚¹å…³æ³¨æ½œåœ¨çš„bugã€æ€§èƒ½é—®é¢˜ã€å¯è¯»æ€§å’Œæœ€ä½³å®è·µã€‚è¯·ä»¥ç®€æ´çš„Markdownæ ¼å¼è¿”å›å®¡æŸ¥æ„è§ã€‚åœ¨ä½ çš„å®¡æŸ¥æ„è§çš„å¼€å¤´ï¼Œè¯·ç”¨â€œ[è¯„åˆ†: n/5]â€çš„æ ¼å¼ç»™å‡ºæœ¬æ¬¡ä»£ç ä¿®æ”¹çš„è¯„åˆ†ï¼Œå…¶ä¸­nä¸º1åˆ°5çš„æ•´æ•°ã€‚
            ---
            ${DIFF_CONTENT}
            ---
            è¯·è¿”å›å®¡æŸ¥ç»“æœã€‚å¦‚æœæ²¡æœ‰å‘ç°ä»»ä½•éœ€è¦æ”¹è¿›çš„é—®é¢˜ï¼Œè¯·å›å¤"ä»£ç å®¡æŸ¥é€šè¿‡ï¼Œæ²¡æœ‰å‘ç°é—®é¢˜ã€‚"`;
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
              },
              body: JSON.stringify({
                model: 'deepseek-coder',
                messages: [
                  { role: 'user', content: prompt }
                ],
                stream: false
              })
            });
            if (!response.ok) {
              throw new Error(`DeepSeek API error: ${response.statusText}`);
            }
            const data = await response.json();
            const review_comment = data.choices[0].message.content;
            console.log("DeepSeekçš„å®¡æŸ¥æ„è§:", review_comment);
            // å°†å®¡æŸ¥æ„è§ä¿å­˜åˆ°è¾“å‡ºå˜é‡ä¸­
            core.setOutput('review_comment', review_comment);
      - name: Create Issue from review
        if: steps.deepseek_review.outputs.review_comment && !contains(steps.deepseek_review.outputs.review_comment, 'ä»£ç å®¡æŸ¥é€šè¿‡ï¼Œæ²¡æœ‰å‘ç°é—®é¢˜ã€‚')
        uses: actions/github-script@v6
        env:
          REVIEW_COMMENT: ${{ steps.deepseek_review.outputs.review_comment }}
        with:
          script: |
            const { REVIEW_COMMENT } = process.env;
            const commitSha = context.sha.substring(0, 7); // è·å–çŸ­ SHA
            
            // æå–å®¡æŸ¥æ„è§çš„å‰50ä¸ªå­—ç¬¦ä½œä¸ºæè¿°
            let description = REVIEW_COMMENT.trim().split('\n')[0].substring(0, 50);
            if (REVIEW_COMMENT.length > 50) {
              description += '...'; // æ·»åŠ çœç•¥å·ä»¥ç¤ºæˆªæ–­
            }

            // æ„å»ºæ–°çš„ Issue æ ‡é¢˜
            const issueTitle = `ğŸ¤– ä»£ç å®¡æŸ¥å»ºè®®: ${description} (Commit ${commitSha})`;
                        
            // Issue æè¿°æ­£æ–‡åŒ…å«å®Œæ•´çš„å®¡æŸ¥æ„è§ï¼Œå…¶ä¸­åŒ…å«äº†è¯„åˆ†
            const issueBody = `### ğŸ¤– DeepSeek AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n**Commit:** ${context.sha}\n**ä½œè€…:** ${context.actor}\n\n${REVIEW_COMMENT}\n\n---
            <br/>*æ­¤ Issue ç”± DeepSeek AI è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºè·Ÿè¸ªä»£ç å®¡æŸ¥å»ºè®®ã€‚*`;
            // ä½¿ç”¨ github.rest.issues.create æ–¹æ³•åˆ›å»º Issue
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody
            });
